<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AboElfadl V5 | ضغط وإرسال</title>
    
    <!-- مكتبات النظام -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- مكتبة ضغط الملفات JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-gold: #D4AF37;
            --color-red: #DC2626;
            --bg-dark: #050505;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            color: #fff;
            overflow-x: hidden;
        }
        .font-code { font-family: 'Fira Code', monospace; }
        
        .glass-panel {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        /* Zip Processing Animation */
        .processing-pulse {
            animation: pulse-border 1.5s infinite;
        }
        @keyframes pulse-border {
            0% { border-color: var(--color-gold); box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); }
            70% { border-color: transparent; box-shadow: 0 0 0 5px rgba(212, 175, 55, 0); }
            100% { border-color: var(--color-gold); box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col selection:bg-red-900 selection:text-white">

    <!-- Header -->
    <header class="fixed top-0 w-full z-50 bg-black/95 border-b border-gray-800 h-16 flex items-center justify-between px-4 shadow-lg">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-red-900 flex items-center justify-center border border-red-500">
                <i class="fas fa-shield-alt text-white"></i>
            </div>
            <div>
                <h1 class="font-black text-base tracking-wide leading-none">ABOELFADL <span class="text-red-600">V5</span></h1>
                <span class="text-[9px] text-gray-500 font-code">AUTO-ZIP ENABLED</span>
            </div>
        </div>
        
        <div class="flex gap-2">
            <!-- Disconnect Button -->
            <button onclick="endSession()" class="hidden bg-red-900/20 hover:bg-red-600 border border-red-800 text-red-500 hover:text-white px-3 py-1.5 rounded text-xs font-bold transition flex items-center gap-2" id="disconnect-btn">
                <i class="fas fa-power-off"></i> إنهاء
            </button>

            <div id="status-badge" class="flex items-center gap-2 px-3 py-1 rounded border border-gray-800 bg-gray-900/50 text-xs font-bold text-gray-500 transition-all">
                <div class="w-2 h-2 rounded-full bg-gray-600" id="status-dot"></div>
                <span id="status-text">غير متصل</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-24 pb-10 px-4 w-full max-w-5xl mx-auto">

        <!-- Connection Area -->
        <div id="connection-view" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- My ID -->
            <div class="glass-panel p-5 rounded-xl">
                <label class="text-xs text-gray-400 font-bold block mb-2">معرفك الشخصي</label>
                <div class="flex gap-2">
                    <div class="flex-1 bg-black/50 border border-gray-700 p-2 rounded text-center text-gold font-code select-all" id="my-id">...</div>
                    <button onclick="copyId()" class="bg-gray-800 px-3 rounded text-gray-400 hover:text-white transition"><i class="fas fa-copy"></i></button>
                </div>
            </div>
            <!-- Connect To -->
            <div class="glass-panel p-5 rounded-xl">
                <label class="text-xs text-gray-400 font-bold block mb-2">الاتصال بـ (Remote ID)</label>
                <div class="flex gap-2">
                    <input type="text" id="remote-id" placeholder="أدخل المعرف هنا" class="flex-1 bg-black/50 border border-gray-700 p-2 rounded text-white font-code outline-none focus:border-red-600 transition">
                    <button onclick="connectPeer()" id="connect-btn" class="bg-red-700 hover:bg-red-600 text-white px-4 rounded font-bold text-xs transition">ربط</button>
                </div>
            </div>
        </div>

        <!-- Dashboard (Hidden until connected) -->
        <div id="dashboard" class="hidden opacity-0 transition-opacity duration-500">
            
            <!-- Controls Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Upload Files -->
                <div onclick="document.getElementById('file-input').click()" class="glass-panel p-6 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 transition group h-32">
                    <i class="fas fa-file-invoice text-3xl text-blue-500 mb-2 group-hover:scale-110 transition"></i>
                    <span class="font-bold text-sm">إرسال ملفات</span>
                    <span class="text-[10px] text-gray-500">اختيار متعدد</span>
                    <input type="file" id="file-input" multiple class="hidden">
                </div>

                <!-- Upload Folder (Auto Zip) -->
                <div onclick="document.getElementById('folder-input').click()" class="glass-panel p-6 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-gold transition group h-32 relative overflow-hidden">
                    <div class="absolute top-0 right-0 bg-gold text-black text-[9px] font-bold px-2 py-1 rounded-bl">AUTO ZIP</div>
                    <i class="fas fa-file-archive text-3xl text-gold mb-2 group-hover:scale-110 transition"></i>
                    <span class="font-bold text-sm">إرسال مجلد</span>
                    <span class="text-[10px] text-gray-500">سيتم ضغطه وإرساله كـ ZIP</span>
                    <input type="file" id="folder-input" webkitdirectory directory class="hidden">
                </div>

                <!-- Status Panel -->
                <div class="glass-panel p-4 rounded-xl flex flex-col justify-center gap-2 h-32">
                    <div class="flex justify-between items-center text-xs text-gray-400">
                        <span>المرسلة:</span>
                        <span id="stat-sent" class="text-white font-code">0</span>
                    </div>
                    <div class="flex justify-between items-center text-xs text-gray-400">
                        <span>المستلمة:</span>
                        <span id="stat-received" class="text-white font-code">0</span>
                    </div>
                    <div class="w-full bg-gray-800 h-1 rounded mt-1"></div>
                    <div id="zip-status" class="text-[10px] text-gold text-center hidden animate-pulse">
                        <i class="fas fa-cog fa-spin"></i> جاري ضغط الملفات...
                    </div>
                </div>
            </div>

            <!-- Queue & Progress -->
            <div class="glass-panel rounded-xl p-0 overflow-hidden min-h-[300px] flex flex-col">
                <div class="bg-black/40 p-3 border-b border-gray-800 flex justify-between items-center">
                    <h3 class="text-sm font-bold text-gray-300"><i class="fas fa-satellite-dish mr-2"></i>مركز العمليات</h3>
                    <span class="text-[10px] bg-gray-800 px-2 rounded text-gray-400">Logs</span>
                </div>
                
                <!-- Progress Bar Area -->
                <div id="progress-container" class="hidden bg-red-900/20 p-4 border-b border-red-500/30">
                    <div class="flex justify-between text-xs mb-2">
                        <span id="progress-filename" class="text-white truncate max-w-[200px]">filename.ext</span>
                        <span id="progress-percent" class="text-gold font-code">0%</span>
                    </div>
                    <div class="w-full bg-gray-900 h-1.5 rounded-full overflow-hidden">
                        <div id="progress-bar" class="bg-red-600 h-full w-0 transition-all"></div>
                    </div>
                </div>

                <!-- Logs List -->
                <div id="logs-area" class="flex-1 p-4 overflow-y-auto space-y-2 max-h-[300px] font-code text-[11px]">
                    <div class="text-gray-600 text-center mt-10 italic">جاهز لاستقبال الأوامر...</div>
                </div>
            </div>
        </div>

    </main>

    <footer class="text-center text-[10px] text-gray-600 py-4">
        AboElfadl Systems V5 - Secure & Compress
    </footer>

    <script>
        // --- تهيئة المتغيرات ---
        let peer = null;
        let conn = null;
        let myId = null;
        let fileQueue = [];
        let isProcessing = false;
        let stats = { sent: 0, received: 0 };

        // --- بدء التشغيل ---
        window.onload = initPeer;

        function initPeer() {
            peer = new Peer(null, { debug: 1 });
            
            peer.on('open', (id) => {
                myId = id;
                document.getElementById('my-id').innerText = id;
            });

            peer.on('connection', (c) => setupConnection(c));
            
            peer.on('disconnected', () => {
                updateStatus('offline');
                resetUI();
            });

            peer.on('error', (err) => console.error(err));
        }

        // --- الاتصال ---
        function connectPeer() {
            const remote = document.getElementById('remote-id').value;
            if(!remote) return;
            const c = peer.connect(remote);
            setupConnection(c);
        }

        function setupConnection(c) {
            conn = c;
            conn.on('open', () => {
                updateStatus('online');
                showDashboard();
                conn.send({type: 'sys', msg: 'اتصال ناجح'});
            });

            conn.on('data', handleData);
            
            conn.on('close', () => {
                endSession();
            });
        }

        // --- إنهاء الجلسة (الزر الجديد) ---
        function endSession() {
            if(conn) {
                conn.close();
            }
            if(peer) {
                peer.destroy(); // تدمير الهوية بالكامل
            }
            alert("تم إنهاء الجلسة وتدمير الاتصال.");
            location.reload(); // إعادة تحميل الصفحة لتنظيف الذاكرة
        }

        // --- معالجة الملفات العادية ---
        document.getElementById('file-input').addEventListener('change', (e) => {
            addToQueue(Array.from(e.target.files));
        });

        // --- معالجة المجلدات (ضغط ZIP) ---
        document.getElementById('folder-input').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if(files.length === 0) return;

            // إظهار حالة الضغط
            document.getElementById('zip-status').classList.remove('hidden');
            log(`جاري ضغط ${files.length} ملفات...`, 'info');

            try {
                const zip = new JSZip();
                
                // إضافة الملفات للأرشيف
                // نستخدم webkitRelativePath للحفاظ على هيكل المجلد
                let folderName = "Archive";
                if(files[0].webkitRelativePath) {
                    folderName = files[0].webkitRelativePath.split('/')[0];
                }

                files.forEach(file => {
                    zip.file(file.webkitRelativePath || file.name, file);
                });

                // إنشاء الملف المضغوط
                const content = await zip.generateAsync({type: "blob"}, (metadata) => {
                    // يمكن إضافة شريط تقدم للضغط هنا مستقبلاً
                });

                // تحويل Blob إلى ملف
                const zipFile = new File([content], `${folderName}.zip`, {type: "application/zip"});
                
                log(`تم الضغط بنجاح! الحجم: ${formatBytes(zipFile.size)}`, 'success');
                document.getElementById('zip-status').classList.add('hidden');

                // إضافة الملف المضغوط للطابور
                addToQueue([zipFile]);

            } catch (err) {
                console.error(err);
                log("فشل في ضغط المجلد", "error");
                document.getElementById('zip-status').classList.add('hidden');
            }
        });

        // --- نظام الطابور والإرسال ---
        function addToQueue(files) {
            fileQueue.push(...files);
            if(!isProcessing) processQueue();
        }

        async function processQueue() {
            if(fileQueue.length === 0) {
                isProcessing = false;
                document.getElementById('progress-container').classList.add('hidden');
                return;
            }

            isProcessing = true;
            const file = fileQueue.shift(); // أخذ الملف الأول
            
            await sendFile(file);
            
            stats.sent++;
            document.getElementById('stat-sent').innerText = stats.sent;
            setTimeout(processQueue, 500);
        }

        function sendFile(file) {
            return new Promise((resolve) => {
                if(!conn || !conn.open) return resolve(); // تخطي إذا انقطع الاتصال

                document.getElementById('progress-container').classList.remove('hidden');
                document.getElementById('progress-filename').innerText = `Sending: ${file.name}`;
                log(`جاري إرسال: ${file.name}`, 'info');

                conn.send({
                    type: 'meta',
                    name: file.name,
                    size: file.size,
                    mime: file.type
                });

                const chunkSize = 16 * 1024;
                let offset = 0;
                const reader = new FileReader();

                reader.onload = (e) => {
                    conn.send({ type: 'chunk', content: e.target.result });
                    offset += chunkSize;
                    
                    // تحديث الواجهة
                    const percent = Math.min(100, ((offset/file.size)*100)).toFixed(0);
                    document.getElementById('progress-bar').style.width = `${percent}%`;
                    document.getElementById('progress-percent').innerText = `${percent}%`;

                    if(offset < file.size) {
                        setTimeout(() => readSlice(offset), 0);
                    } else {
                        log(`تم الإرسال: ${file.name}`, 'success');
                        resolve();
                    }
                };

                const readSlice = (o) => {
                    const slice = file.slice(o, o + chunkSize);
                    reader.readAsArrayBuffer(slice);
                };

                readSlice(0);
            });
        }

        // --- الاستقبال ---
        let incoming = { chunks: [], meta: null, received: 0 };

        function handleData(data) {
            if(data.type === 'sys') {
                log(`النظام: ${data.msg}`, 'sys');
            }
            else if(data.type === 'meta') {
                incoming.meta = data;
                incoming.chunks = [];
                incoming.received = 0;
                document.getElementById('progress-container').classList.remove('hidden');
                document.getElementById('progress-filename').innerText = `Receiving: ${data.name}`;
                log(`استقبال ملف: ${data.name}`, 'info');
            }
            else if(data.type === 'chunk') {
                incoming.chunks.push(data.content);
                incoming.received += data.content.byteLength;
                
                const percent = Math.min(100, ((incoming.received/incoming.meta.size)*100)).toFixed(0);
                document.getElementById('progress-bar').style.width = `${percent}%`;
                document.getElementById('progress-percent').innerText = `${percent}%`;

                if(incoming.received >= incoming.meta.size) {
                    saveReceivedFile();
                }
            }
        }

        function saveReceivedFile() {
            const blob = new Blob(incoming.chunks, { type: incoming.meta.mime });
            const url = URL.createObjectURL(blob);
            
            // إنشاء رابط تحميل تلقائي
            const a = document.createElement('a');
            a.href = url;
            a.download = incoming.meta.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            stats.received++;
            document.getElementById('stat-received').innerText = stats.received;
            log(`تم الحفظ: ${incoming.meta.name}`, 'success');
            
            // إخفاء شريط التقدم بعد ثانية
            setTimeout(() => {
                document.getElementById('progress-container').classList.add('hidden');
            }, 1000);
        }

        // --- أدوات الواجهة ---
        function updateStatus(status) {
            const badge = document.getElementById('status-badge');
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const disconnectBtn = document.getElementById('disconnect-btn');

            if(status === 'online') {
                badge.className = "flex items-center gap-2 px-3 py-1 rounded border border-green-900 bg-green-900/20 text-xs font-bold text-green-400";
                dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
                text.innerText = "متصل آمن";
                disconnectBtn.classList.remove('hidden');
            } else {
                badge.className = "flex items-center gap-2 px-3 py-1 rounded border border-gray-800 bg-gray-900/50 text-xs font-bold text-gray-500";
                dot.className = "w-2 h-2 rounded-full bg-gray-600";
                text.innerText = "غير متصل";
                disconnectBtn.classList.add('hidden');
            }
        }

        function showDashboard() {
            document.getElementById('dashboard').classList.remove('hidden');
            setTimeout(() => document.getElementById('dashboard').classList.remove('opacity-0'), 100);
            document.getElementById('connection-view').classList.add('hidden');
        }

        function resetUI() {
            document.getElementById('dashboard').classList.add('hidden', 'opacity-0');
            document.getElementById('connection-view').classList.remove('hidden');
        }

        function log(msg, type) {
            const container = document.getElementById('logs-area');
            if(container.querySelector('.text-center')) container.innerHTML = ''; // مسح رسالة الترحيب

            const color = type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-500' : type === 'sys' ? 'text-gold' : 'text-blue-300';
            const icon = type === 'success' ? '✔' : type === 'error' ? '✖' : 'ℹ';
            
            const div = document.createElement('div');
            div.className = `border-b border-gray-800 pb-1 ${color}`;
            div.innerHTML = `<span class="mr-2 opacity-50 text-[9px]">${new Date().toLocaleTimeString()}</span> ${icon} ${msg}`;
            
            container.insertBefore(div, container.firstChild);
        }

        function copyId() {
            navigator.clipboard.writeText(myId);
            alert("تم النسخ");
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return parseFloat((bytes / Math.pow(1024, i)).toFixed(1)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>


