<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AboElfadl Operation Room | نقل مشفر</title>
    
    <!-- مكتبة Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- مكتبة PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- أيقونات FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- خط Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #050505;
            color: #ffffff;
            overflow-x: hidden;
        }
        
        /* خط الأرقام والأكواد */
        .font-mono-num { font-family: 'JetBrains Mono', monospace; }

        /* الألوان الخاصة ببراند أبو الفضل */
        .text-gold { color: #D4AF37; }
        .border-gold { border-color: #D4AF37; }
        .bg-gold { background-color: #D4AF37; }
        .text-red-main { color: #DC2626; }
        .bg-red-main { background-color: #DC2626; }

        /* الزجاج الخلفي */
        .glass-panel {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        /* أنيميشن */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* تأثير المسح الراداري */
        .radar-scan {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(180deg, rgba(220, 38, 38, 0) 0%, rgba(220, 38, 38, 0.1) 50%, rgba(220, 38, 38, 0) 100%);
            background-size: 100% 200%;
            animation: radar 3s linear infinite;
            pointer-events: none;
            z-index: 0;
        }
        @keyframes radar { 0% { background-position: 0% -100%; } 100% { background-position: 0% 200%; } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 selection:bg-red-900 selection:text-white">

    <!-- خلفية تقنية -->
    <div class="fixed inset-0 z-0 opacity-20" 
         style="background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;">
    </div>

    <!-- الهيدر الثابت -->
    <header class="fixed top-0 w-full p-4 z-50 bg-black/80 backdrop-blur-md border-b border-gray-800 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <i class="fas fa-shield-virus text-gold text-2xl"></i>
            <div>
                <h1 class="font-bold text-lg tracking-wider">ABOELFADL <span class="text-red-main">SECURE</span></h1>
            </div>
        </div>
        <div id="connection-status-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-900 text-gray-500 border border-gray-700 flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-gray-500"></div>
            غير متصل
        </div>
    </header>

    <!-- المحتوى الرئيسي -->
    <main class="w-full max-w-5xl z-10 pt-20">

        <!-- الشاشة 1: تسجيل الدخول والربط -->
        <div id="login-view" class="w-full max-w-2xl mx-auto fade-in">
            <div class="glass-panel rounded-2xl p-8 relative overflow-hidden">
                <div class="radar-scan"></div>
                
                <h2 class="text-2xl font-bold mb-6 text-center text-gold relative z-10">إعداد القناة الآمنة</h2>
                
                <!-- هويتي -->
                <div class="mb-8 relative z-10">
                    <label class="text-xs text-gray-400 block mb-2">معرفك الرقمي (شاركه مع الطرف الآخر)</label>
                    <div class="flex gap-2">
                        <div class="flex-1 bg-black/60 border border-red-900/50 rounded-lg p-3 font-mono-num text-lg text-center tracking-wider text-red-500 select-all" id="my-id">
                            جاري التشفير...
                        </div>
                        <button onclick="copyId()" class="bg-gray-800 hover:bg-gray-700 text-white px-4 rounded-lg transition border border-gray-600">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>

                <!-- الاتصال -->
                <div class="relative z-10">
                    <label class="text-xs text-gray-400 block mb-2">معرف الطرف المستقبل</label>
                    <div class="flex gap-2">
                        <input type="text" id="remote-id-input" placeholder="أدخل ID الجهاز الآخر هنا..." 
                               class="flex-1 bg-black/60 border border-gray-700 rounded-lg p-3 text-white focus:border-gold outline-none transition font-mono-num">
                        <button onclick="connectToPeer()" class="bg-gradient-to-r from-red-800 to-red-600 hover:from-red-700 hover:to-red-500 text-white px-6 rounded-lg font-bold shadow-lg shadow-red-900/30 transition">
                            <i class="fas fa-link mr-2"></i> ربط
                        </button>
                    </div>
                </div>
                
                <p class="text-center text-xs text-gray-500 mt-6 relative z-10">
                    <i class="fas fa-lock text-gold ml-1"></i> الاتصال محمي بتقنية WebRTC P2P (بدون سيرفر وسيط)
                </p>
            </div>
        </div>

        <!-- الشاشة 2: لوحة التحكم (تظهر بعد الاتصال) -->
        <div id="dashboard-view" class="hidden w-full fade-in">
            
            <!-- شريط المعلومات العلوي (Stats) -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <!-- بطاقة مرسلة -->
                <div class="glass-panel p-4 rounded-xl border-r-4 border-r-blue-500">
                    <div class="text-gray-400 text-xs mb-1">الملفات المرسلة</div>
                    <div class="text-2xl font-bold font-mono-num" id="stat-sent">0</div>
                    <div class="text-xs text-blue-400 mt-1"><i class="fas fa-upload"></i> صادر</div>
                </div>

                <!-- بطاقة مستقبلة -->
                <div class="glass-panel p-4 rounded-xl border-r-4 border-r-green-500">
                    <div class="text-gray-400 text-xs mb-1">الملفات المستقبلة</div>
                    <div class="text-2xl font-bold font-mono-num" id="stat-received">0</div>
                    <div class="text-xs text-green-400 mt-1"><i class="fas fa-download"></i> وارد</div>
                </div>

                <!-- إجمالي الحجم -->
                <div class="glass-panel p-4 rounded-xl border-r-4 border-r-gold">
                    <div class="text-gray-400 text-xs mb-1">حجم البيانات (Traffic)</div>
                    <div class="text-2xl font-bold font-mono-num text-gold" id="stat-size">0 MB</div>
                    <div class="text-xs text-yellow-600 mt-1"><i class="fas fa-chart-pie"></i> إجمالي</div>
                </div>

                <!-- حالة الشبكة -->
                <div class="glass-panel p-4 rounded-xl border-r-4 border-r-red-600 bg-red-900/10">
                    <div class="text-gray-400 text-xs mb-1">بروتوكول الأمان</div>
                    <div class="text-lg font-bold text-red-500">AES-128</div>
                    <div class="text-xs text-red-400 mt-1 blink"><i class="fas fa-circle text-[8px]"></i> قناة نشطة</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- منطقة الإرسال -->
                <div class="lg:col-span-2 glass-panel p-6 rounded-xl relative group">
                    <div class="absolute inset-0 bg-red-600/5 opacity-0 group-hover:opacity-100 transition duration-500 rounded-xl pointer-events-none"></div>
                    <h3 class="text-lg font-bold mb-4 flex items-center text-white"><i class="fas fa-satellite-dish ml-2 text-gold"></i> مركز الإرسال</h3>
                    
                    <div id="drop-zone" class="border-2 border-dashed border-gray-700 hover:border-gold rounded-xl h-48 flex flex-col items-center justify-center cursor-pointer transition-all bg-black/20" onclick="document.getElementById('file-input').click()">
                        <input type="file" id="file-input" class="hidden">
                        <i class="fas fa-fingerprint text-4xl text-gray-600 mb-3 group-hover:text-red-500 transition"></i>
                        <p class="font-bold">انقر أو اسحب الملفات هنا</p>
                        <p class="text-xs text-gray-500 mt-1">يدعم جميع الصيغ | تشفير تلقائي</p>
                    </div>

                    <!-- شريط التقدم والوقت -->
                    <div id="active-transfer" class="mt-6 hidden bg-black/40 p-4 rounded-lg border border-gray-800">
                        <div class="flex justify-between items-center mb-2">
                            <span id="current-filename" class="text-sm font-mono-num truncate max-w-[200px] text-white">document.pdf</span>
                            <span id="transfer-speed" class="text-xs text-gold font-mono-num">0 MB/s</span>
                        </div>
                        
                        <div class="w-full bg-gray-800 rounded-full h-2 overflow-hidden mb-2">
                            <div id="progress-bar" class="bg-red-600 h-2 rounded-full w-0 transition-all duration-200"></div>
                        </div>

                        <div class="flex justify-between items-center text-xs text-gray-400">
                            <span id="time-remaining"><i class="fas fa-hourglass-half ml-1"></i>جاري الحساب...</span>
                            <span id="progress-percent" class="text-white font-bold font-mono-num">0%</span>
                        </div>
                    </div>
                </div>

                <!-- سجل العمليات (Logs) -->
                <div class="glass-panel p-4 rounded-xl flex flex-col h-[350px]">
                    <h3 class="text-sm font-bold mb-3 text-gray-400 uppercase tracking-widest border-b border-gray-800 pb-2">سجل النظام</h3>
                    <div id="logs" class="flex-1 overflow-y-auto font-mono-num text-xs space-y-2 pr-2 custom-scrollbar">
                        <!-- Logs here -->
                    </div>
                </div>
            </div>

            <div class="mt-6 text-center">
                <button onclick="location.reload()" class="text-xs text-red-500 hover:text-red-400 underline">
                    <i class="fas fa-power-off ml-1"></i> إنهاء الجلسة وتدمير المفاتيح
                </button>
            </div>
        </div>

    </main>

    <script>
        // --- متغيرات النظام ---
        let peer = null;
        let conn = null;
        let myId = null;
        
        // إحصائيات الجلسة
        let stats = {
            sent: 0,
            received: 0,
            totalBytes: 0
        };

        // متغيرات حساب الوقت والسرعة
        let startTime = 0;
        let lastTime = 0;
        let lastLoaded = 0;

        // --- تهيئة PeerJS ---
        function initSystem() {
            log("جاري تهيئة بروتوكول الاتصال...", "sys");
            peer = new Peer(null, { debug: 1 });

            peer.on('open', (id) => {
                myId = id;
                document.getElementById('my-id').innerText = id;
                document.getElementById('connection-status-badge').innerHTML = `<div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></div> متصل بالشبكة`;
                document.getElementById('connection-status-badge').classList.replace('text-gray-500', 'text-green-400');
                log(`تم إنشاء المعرف: ${id}`, "success");
            });

            peer.on('connection', (c) => {
                setupConnection(c);
            });
        }

        // --- الاتصال بطرف آخر ---
        function connectToPeer() {
            const remoteId = document.getElementById('remote-id-input').value.trim();
            if (!remoteId) return alert("الرجاء إدخال ID الطرف الآخر");
            
            const c = peer.connect(remoteId);
            setupConnection(c);
        }

        // --- إعداد الاتصال وتبديل الشاشة ---
        function setupConnection(connection) {
            conn = connection;

            conn.on('open', () => {
                // الانتقال للوحة التحكم
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('dashboard-view').classList.remove('hidden');
                
                log("تم تأسيس القناة المشفرة بنجاح.", "success");
                
                // تحديث حالة الهيدر
                const badge = document.getElementById('connection-status-badge');
                badge.innerHTML = `<div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div> اتصال مباشر نشط`;
                badge.classList.replace('text-green-400', 'text-white');
                badge.classList.add('bg-red-900/50', 'border-red-600');
            });

            conn.on('data', handleData);
            
            conn.on('close', () => {
                alert("تم قطع الاتصال بالطرف الآخر");
                location.reload();
            });
        }

        // --- معالجة البيانات ---
        let incomingChunks = [];
        let incomingMeta = null;
        let incomingSize = 0;

        function handleData(data) {
            if (data.type === 'meta') {
                incomingMeta = data;
                incomingChunks = [];
                incomingSize = 0;
                startTransferUI(data.name, 'receive');
                log(`بدأ استقبال: ${data.name}`, "info");
            } else if (data.type === 'chunk') {
                incomingChunks.push(data.content);
                incomingSize += data.content.byteLength;
                
                // تحديث الواجهة
                updateTransferUI(incomingSize, incomingMeta.size);

                if (incomingSize >= incomingMeta.size) {
                    finalizeDownload();
                }
            }
        }

        function finalizeDownload() {
            const blob = new Blob(incomingChunks, { type: incomingMeta.mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = incomingMeta.name;
            a.click();
            
            // تحديث الإحصائيات
            stats.received++;
            stats.totalBytes += incomingMeta.size;
            updateDashboardStats();
            
            log(`تم الاستلام بنجاح: ${incomingMeta.name}`, "success");
            endTransferUI();
        }

        // --- الإرسال ---
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && conn) sendFile(file);
        });

        // دعم السحب والإفلات
        const dropZone = document.getElementById('drop-zone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('bg-red-900/20', 'border-red-500'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('bg-red-900/20', 'border-red-500'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-red-900/20', 'border-red-500');
            const file = e.dataTransfer.files[0];
            if (file && conn) sendFile(file);
        });

        function sendFile(file) {
            conn.send({ type: 'meta', name: file.name, size: file.size, mime: file.type });
            
            const chunkSize = 16 * 1024;
            let offset = 0;
            const reader = new FileReader();

            startTransferUI(file.name, 'send');
            log(`جاري إرسال: ${file.name}`, "info");

            reader.onload = (e) => {
                conn.send({ type: 'chunk', content: e.target.result });
                offset += chunkSize;
                
                updateTransferUI(Math.min(offset, file.size), file.size);

                if (offset < file.size) {
                    readSlice(offset);
                } else {
                    stats.sent++;
                    stats.totalBytes += file.size;
                    updateDashboardStats();
                    log(`اكتمل الإرسال: ${file.name}`, "success");
                    endTransferUI();
                }
            };

            const readSlice = (o) => {
                const slice = file.slice(o, o + chunkSize);
                reader.readAsArrayBuffer(slice);
            };
            readSlice(0);
        }

        // --- منطق حساب الوقت والسرعة ---
        function startTransferUI(filename, type) {
            document.getElementById('active-transfer').classList.remove('hidden');
            document.getElementById('current-filename').innerText = (type === 'send' ? 'جاري الإرسال: ' : 'جاري الاستقبال: ') + filename;
            startTime = Date.now();
            lastTime = startTime;
            lastLoaded = 0;
        }

        function updateTransferUI(loaded, total) {
            const now = Date.now();
            const percent = ((loaded / total) * 100).toFixed(1);
            
            // تحديث الشريط
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-percent').innerText = `${percent}%`;

            // حساب السرعة والوقت كل 500ms لتجنب الوميض
            if (now - lastTime >= 500) {
                const durationInSeconds = (now - startTime) / 1000;
                const bytesPerSecond = loaded / durationInSeconds; // متوسط السرعة
                
                // حساب الوقت المتبقي
                const remainingBytes = total - loaded;
                const remainingSeconds = remainingBytes / bytesPerSecond;

                // العرض
                document.getElementById('transfer-speed').innerText = formatSize(bytesPerSecond) + '/s';
                document.getElementById('time-remaining').innerHTML = `<i class="fas fa-clock ml-1"></i> متبقي: ${formatTime(remainingSeconds)}`;

                lastTime = now;
            }
        }

        function endTransferUI() {
            setTimeout(() => {
                document.getElementById('active-transfer').classList.add('hidden');
                document.getElementById('progress-bar').style.width = '0';
            }, 1000);
        }

        function updateDashboardStats() {
            document.getElementById('stat-sent').innerText = stats.sent;
            document.getElementById('stat-received').innerText = stats.received;
            document.getElementById('stat-size').innerText = formatSize(stats.totalBytes);
        }

        // --- دوال مساعدة ---
        function log(msg, type) {
            const logs = document.getElementById('logs');
            const color = type === 'error' ? 'text-red-500' : type === 'success' ? 'text-green-400' : 'text-gray-300';
            const icon = type === 'success' ? '>' : type === 'error' ? '!' : '#';
            
            logs.innerHTML += `<div class="border-b border-gray-800/50 pb-1 mb-1">
                <span class="text-gold font-bold mr-1">${icon}</span>
                <span class="${color}">${msg}</span>
            </div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatTime(seconds) {
            if (!isFinite(seconds) || seconds < 0) return "جاري الحساب...";
            if (seconds < 60) return `${Math.ceil(seconds)} ثانية`;
            const m = Math.floor(seconds / 60);
            const s = Math.ceil(seconds % 60);
            return `${m} دقيقة و ${s} ثانية`;
        }

        function copyId() {
            const id = document.getElementById('my-id').innerText;
            navigator.clipboard.writeText(id);
            log("تم نسخ المعرف للحافظة", "sys");
        }

        window.onload = initSystem;
    </script>
</body>
</html>


