<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AboElfadl Secure Share | مشاركة ملفات آمنة</title>
    
    <!-- مكتبة Tailwind CSS للتصميم -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- مكتبة PeerJS للاتصال المباشر بين الأجهزة -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- أيقونات FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* تخصيص الألوان والخطوط حسب طلب أبو الفضل */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0a0a0a; /* أسود داكن */
            color: #ffffff;
            overflow-x: hidden;
        }

        /* تأثيرات ذهبية */
        .text-gold { color: #D4AF37; }
        .border-gold { border-color: #D4AF37; }
        .bg-gold { background-color: #D4AF37; }
        
        /* تأثيرات حمراء */
        .text-red-main { color: #DC2626; }
        .bg-red-main { background-color: #DC2626; }

        /* سكرول بار مخصص */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #DC2626; }

        .glass-panel {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .loader {
            border-top-color: #D4AF37;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* تأثير النبض للاتصال */
        .pulse-ring {
            box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 relative selection:bg-red-600 selection:text-white">

    <!-- الخلفية الشبكية التقنية -->
    <div class="fixed inset-0 z-0 opacity-10 pointer-events-none" 
         style="background-image: radial-gradient(#333 1px, transparent 1px); background-size: 30px 30px;">
    </div>

    <!-- الهيدر -->
    <header class="w-full max-w-4xl flex justify-between items-center mb-8 z-10 animate-fade-in-down">
        <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-full border-2 border-gold flex items-center justify-center bg-black">
                <i class="fas fa-shield-alt text-gold text-xl"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold tracking-wider">ABOELFADL <span class="text-red-main">SECURE</span></h1>
                <p class="text-xs text-gray-400">P2P File Transfer Protocol</p>
            </div>
        </div>
        <div class="text-xs text-gold border border-gold px-3 py-1 rounded bg-black/50">
            <i class="fas fa-lock ml-1"></i> مشفر طرفي (End-to-End)
        </div>
    </header>

    <!-- المحتوى الرئيسي -->
    <main class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-6 z-10">
        
        <!-- بطاقة جهازي (Sender/Receiver ID) -->
        <div class="glass-panel p-6 rounded-xl flex flex-col relative overflow-hidden group">
            <div class="absolute top-0 right-0 w-24 h-24 bg-red-600/10 rounded-bl-full -mr-4 -mt-4 transition-all group-hover:bg-red-600/20"></div>
            
            <h2 class="text-xl font-bold mb-4 flex items-center text-white">
                <i class="fas fa-id-card ml-2 text-red-main"></i> هويتك الرقمية
            </h2>
            
            <div class="bg-black/50 p-4 rounded-lg border border-gray-800 mb-4">
                <p class="text-sm text-gray-400 mb-1">الـ ID الخاص بك:</p>
                <div class="flex items-center gap-2">
                    <span id="my-id" class="text-gold font-mono text-lg font-bold truncate">جاري التوليد...</span>
                    <button onclick="copyId()" class="p-2 hover:bg-gray-800 rounded transition text-gray-300 hover:text-white" title="نسخ">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>

            <p class="text-sm text-gray-400 mt-auto">
                <i class="fas fa-info-circle ml-1"></i> شارك هذا المعرف مع الجهاز الآخر لتبدأ الاتصال.
            </p>
        </div>

        <!-- بطاقة الاتصال -->
        <div class="glass-panel p-6 rounded-xl flex flex-col">
            <h2 class="text-xl font-bold mb-4 flex items-center text-white">
                <i class="fas fa-network-wired ml-2 text-red-main"></i> الاتصال بجهاز آخر
            </h2>

            <div class="flex flex-col gap-3">
                <label class="text-sm text-gray-400">أدخل ID الجهاز الآخر:</label>
                <div class="flex gap-2">
                    <input type="text" id="remote-id-input" placeholder="ألصق الـ ID هنا..." 
                           class="flex-1 bg-black/50 border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-red-600 transition font-mono">
                    <button onclick="connectToPeer()" 
                            class="bg-red-700 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition font-bold shadow-lg shadow-red-900/20">
                        ربط
                    </button>
                </div>
                <div id="status-display" class="text-sm mt-2 flex items-center gap-2 text-gray-400">
                    <span class="w-2 h-2 rounded-full bg-gray-500 inline-block" id="status-dot"></span>
                    <span id="status-text">في انتظار الاتصال...</span>
                </div>
            </div>
        </div>

        <!-- منطقة نقل الملفات (تظهر بعد الاتصال) -->
        <div id="transfer-area" class="glass-panel p-6 rounded-xl md:col-span-2 hidden opacity-0 transition-all duration-500">
            <div class="border-b border-gray-800 pb-4 mb-4 flex justify-between items-center">
                <h3 class="text-lg font-bold text-gold"><i class="fas fa-exchange-alt ml-2"></i> منطقة النقل</h3>
                <span class="text-xs bg-green-900 text-green-300 px-2 py-1 rounded">متصل آمن</span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- إرسال -->
                <div class="border-2 border-dashed border-gray-700 hover:border-red-600 rounded-xl p-8 flex flex-col items-center justify-center text-center transition-colors cursor-pointer"
                     id="drop-zone" onclick="document.getElementById('file-input').click()">
                    <input type="file" id="file-input" class="hidden">
                    <div class="w-16 h-16 bg-gray-900 rounded-full flex items-center justify-center mb-4 text-3xl text-gray-500 group-hover:text-red-600">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <p class="font-bold text-white mb-1">اضغط لاختيار ملف</p>
                    <p class="text-xs text-gray-400">أو اسحب الملف وأفلته هنا</p>
                </div>

                <!-- استقبال / سجل -->
                <div class="bg-black/40 rounded-xl p-4 border border-gray-800 min-h-[150px] flex flex-col">
                    <h4 class="text-sm font-bold text-gray-300 mb-3 border-b border-gray-800 pb-2">سجل النشاط</h4>
                    <div id="logs" class="flex-1 overflow-y-auto text-xs font-mono space-y-2 max-h-[150px]">
                        <!-- الرسائل ستظهر هنا -->
                    </div>
                </div>
            </div>

            <!-- شريط التقدم -->
            <div id="progress-container" class="mt-6 hidden">
                <div class="flex justify-between text-xs mb-1">
                    <span id="progress-text" class="text-gray-300">جاري النقل...</span>
                    <span id="progress-percent" class="text-gold font-bold">0%</span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-2 overflow-hidden">
                    <div id="progress-bar" class="bg-gradient-to-r from-red-700 to-red-500 h-2 rounded-full w-0 transition-all duration-300"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- الفوتر -->
    <footer class="mt-12 text-center text-gray-500 text-xs z-10">
        <p>&copy; 2025 AboElfadl Development. All Rights Reserved.</p>
        <p class="mt-1 opacity-50">Secure File Sharing System v1.0</p>
    </footer>

    <!-- سكريبت الوظائف -->
    <script>
        // --- تهيئة المتغيرات ---
        let peer = null;
        let conn = null;
        let myId = null;

        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const transferArea = document.getElementById('transfer-area');
        const logs = document.getElementById('logs');
        const progressBar = document.getElementById('progress-bar');
        const progressContainer = document.getElementById('progress-container');
        const progressPercent = document.getElementById('progress-percent');

        // --- تهيئة PeerJS ---
        function initPeer() {
            log("جاري تهيئة الاتصال الآمن...", "info");
            // إنشاء معرف عشوائي لكن يبدو احترافي
            // استخدام السيرفر الافتراضي المجاني لـ PeerJS
            peer = new Peer(null, {
                debug: 2
            });

            peer.on('open', (id) => {
                myId = id;
                document.getElementById('my-id').innerText = id;
                updateStatus("جاهز للاتصال", "green");
                log(`تم إنشاء الهوية: ${id}`, "success");
            });

            peer.on('connection', (connection) => {
                handleConnection(connection);
            });

            peer.on('error', (err) => {
                console.error(err);
                updateStatus("خطأ في الاتصال", "red");
                log(`خطأ: ${err.type}`, "error");
            });
        }

        // --- الاتصال بجهاز آخر ---
        function connectToPeer() {
            const remoteId = document.getElementById('remote-id-input').value.trim();
            if (!remoteId) {
                alert("يرجى إدخال ID الجهاز الآخر");
                return;
            }
            if (remoteId === myId) {
                alert("لا يمكنك الاتصال بنفسك!");
                return;
            }

            updateStatus("جاري الاتصال...", "yellow");
            log(`محاولة الاتصال بـ: ${remoteId}`, "info");
            
            const connection = peer.connect(remoteId);
            handleConnection(connection);
        }

        // --- معالجة الاتصال (سواء وارد أو صادر) ---
        function handleConnection(connection) {
            conn = connection;

            conn.on('open', () => {
                updateStatus("تم الاتصال بنجاح", "green");
                log("قناة البيانات مفتوحة ومشفرة.", "success");
                showTransferArea();
                
                // إرسال رسالة ترحيبية تلقائية
                conn.send({ type: 'msg', content: 'تم تبادل المفاتيح بنجاح.' });
            });

            conn.on('data', (data) => {
                handleData(data);
            });

            conn.on('close', () => {
                updateStatus("تم قطع الاتصال", "red");
                log("انقطع الاتصال بالطرف الآخر.", "error");
            });
        }

        // --- معالجة البيانات المستلمة ---
        let receivedChunks = [];
        let receivedSize = 0;
        let fileMeta = null;

        function handleData(data) {
            if (data.type === 'msg') {
                log(`النظام: ${data.content}`, "info");
            } 
            else if (data.type === 'meta') {
                // استلام بيانات وصفية للملف
                fileMeta = data;
                receivedChunks = [];
                receivedSize = 0;
                log(`جاري استقبال: ${fileMeta.name} (${formatBytes(fileMeta.size)})`, "info");
                showProgress(0);
            } 
            else if (data.type === 'chunk') {
                // استلام جزء من الملف
                receivedChunks.push(data.content);
                receivedSize += data.content.byteLength;
                
                const percent = Math.round((receivedSize / fileMeta.size) * 100);
                updateProgress(percent);

                if (receivedSize >= fileMeta.size) {
                    // اكتمل الملف
                    saveFile();
                }
            }
        }

        // --- حفظ الملف المستلم ---
        function saveFile() {
            log("اكتمل التنزيل. جاري تجميع الملف...", "success");
            const blob = new Blob(receivedChunks, { type: fileMeta.mime });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileMeta.name;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                resetProgress();
            }, 100);
            
            log(`تم حفظ الملف: ${fileMeta.name}`, "success");
        }

        // --- إرسال الملف ---
        const fileInput = document.getElementById('file-input');
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (!conn || !conn.open) {
                alert("يجب الاتصال بطرف آخر أولاً!");
                return;
            }
            sendFile(file);
        });

        // دعم السحب والإفلات
        const dropZone = document.getElementById('drop-zone');
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-red-600', 'bg-gray-900');
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-red-600', 'bg-gray-900');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-red-600', 'bg-gray-900');
            const file = e.dataTransfer.files[0];
            if (file && conn && conn.open) sendFile(file);
        });

        async function sendFile(file) {
            log(`جاري تجهيز: ${file.name}`, "info");
            
            // 1. إرسال الميتاداتا
            conn.send({
                type: 'meta',
                name: file.name,
                size: file.size,
                mime: file.type
            });

            // 2. تقسيم وإرسال الملف
            const chunkSize = 16 * 1024; // 16KB per chunk (safe for WebRTC)
            const totalChunks = Math.ceil(file.size / chunkSize);
            let offset = 0;

            showProgress(0);

            // استخدام FileReader لقراءة الملف كـ ArrayBuffer
            const reader = new FileReader();
            
            // دالة مساعدة لقراءة جزء معين
            function readSlice(o) {
                const slice = file.slice(offset, o + chunkSize);
                reader.readAsArrayBuffer(slice);
            }

            reader.onload = (e) => {
                conn.send({
                    type: 'chunk',
                    content: e.target.result
                });

                offset += chunkSize;
                const percent = Math.min(100, Math.round((offset / file.size) * 100));
                updateProgress(percent);

                if (offset < file.size) {
                    // قراءة الجزء التالي بسرعة ولكن نعطي فرصة للمتصفح (setTimeout 0)
                    setTimeout(() => readSlice(offset), 5); // تأخير بسيط لمنع تجميد المتصفح
                } else {
                    log("تم إرسال الملف بنجاح.", "success");
                    resetProgress();
                }
            };

            readSlice(0);
        }

        // --- أدوات مساعدة ---
        function updateStatus(text, color) {
            statusText.innerText = text;
            statusDot.className = `w-2 h-2 rounded-full inline-block ${color === 'green' ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.8)]' : color === 'red' ? 'bg-red-500' : 'bg-yellow-500'}`;
            if(color === 'green') document.getElementById('remote-id-input').classList.add('border-green-500');
        }

        function showTransferArea() {
            transferArea.classList.remove('hidden');
            setTimeout(() => {
                transferArea.classList.remove('opacity-0');
            }, 10);
        }

        function copyId() {
            const id = document.getElementById('my-id').innerText;
            navigator.clipboard.writeText(id).then(() => {
                log("تم نسخ الـ ID للحافظة", "success");
            });
        }

        function log(msg, type) {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('en-US', {hour12: false, hour: "numeric", minute: "numeric"});
            div.innerHTML = `<span class="text-gray-500">[${time}]</span> <span class="${type === 'error' ? 'text-red-500' : type === 'success' ? 'text-green-400' : 'text-blue-300'}">${msg}</span>`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function showProgress(percent) {
            progressContainer.classList.remove('hidden');
            updateProgress(percent);
        }

        function updateProgress(percent) {
            progressBar.style.width = `${percent}%`;
            progressPercent.innerText = `${percent}%`;
        }

        function resetProgress() {
            setTimeout(() => {
                progressContainer.classList.add('hidden');
                progressBar.style.width = '0%';
            }, 2000);
        }

        // بدء التشغيل
        window.addEventListener('load', initPeer);

    </script>
</body>
</html>

