<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AboElfadl Hybrid | V6</title>
    
    <!-- المكتبات الأساسية -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- مكتبة ضغط الملفات (V5 Feature) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-gold: #D4AF37;
            --color-red: #DC2626;
            --bg-dark: #050505;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            color: #fff;
            overflow-x: hidden;
        }
        .font-code { font-family: 'Fira Code', monospace; }
        
        /* Glassmorphism Panel (V4 Design) */
        .glass-panel {
            background: rgba(15, 15, 15, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        /* Tabs Styling */
        .tab-btn.active {
            background-color: rgba(220, 38, 38, 0.15);
            border-bottom: 2px solid var(--color-red);
            color: #fff;
        }
        .tab-btn {
            color: #6b7280;
            transition: all 0.3s;
        }

        /* File Type Icons Colors */
        .type-image { color: #a78bfa; } 
        .type-video { color: #f472b6; }
        .type-audio { color: #34d399; }
        .type-code  { color: #60a5fa; }
        .type-doc   { color: #fbbf24; }
        .type-zip   { color: #9ca3af; }

        /* Animations */
        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        .pulse-gold { animation: pulseGold 2s infinite; }
        @keyframes pulseGold { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); } }

        /* Zip Loading Animation */
        .zip-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col selection:bg-red-900 selection:text-white">

    <!-- Header (V4 Style + V5 Kill Switch) -->
    <header class="fixed top-0 w-full z-50 bg-black/95 border-b border-gray-800 h-16 flex items-center justify-between px-4 shadow-lg">
        <div class="flex items-center gap-3">
            <i class="fas fa-shield-virus text-red-600 text-2xl"></i>
            <div>
                <h1 class="font-black text-lg tracking-wide leading-none">ABOELFADL <span class="text-red-600">V6</span></h1>
                <span class="text-[10px] text-gray-500 font-code tracking-widest">HYBRID SYSTEM</span>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <!-- V5 Feature: Kill Switch -->
            <button onclick="endSession()" id="kill-switch" class="hidden bg-red-900/20 hover:bg-red-600 text-red-500 hover:text-white border border-red-900 px-3 py-1 rounded text-[10px] font-bold transition flex items-center gap-1">
                <i class="fas fa-power-off"></i> إنهاء
            </button>

            <div id="status-badge" class="flex items-center gap-2 px-3 py-1 rounded border border-gray-800 bg-gray-900/50 text-xs font-bold text-gray-500 transition-all">
                <div class="w-2 h-2 rounded-full bg-gray-600" id="status-dot"></div>
                <span id="status-text">OFFLINE</span>
            </div>
        </div>
    </header>

    <!-- Main Content (V4 Layout) -->
    <main class="pt-20 pb-10 px-4 w-full max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- Left Column: Controls (4 Cols) -->
        <div class="lg:col-span-4 space-y-4">
            
            <!-- Connection Panel -->
            <div class="glass-panel rounded-xl p-5 relative overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider">لوحة الاتصال</h2>
                    <button onclick="copyMyId()" class="text-xs text-red-500 hover:text-white transition"><i class="fas fa-copy"></i> نسخ ID</button>
                </div>

                <div class="bg-black/50 p-3 rounded border border-gray-800 mb-4 font-code text-center text-gold text-sm break-all select-all" id="my-id">
                    جاري التوليد...
                </div>

                <div id="connect-form" class="space-y-2">
                    <input type="text" id="remote-id" placeholder="ID الطرف الآخر" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm text-center text-white focus:border-red-600 outline-none transition font-code">
                    <button onclick="connectPeer()" class="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-2 rounded text-sm transition shadow-lg shadow-red-900/20">
                        <i class="fas fa-link mr-2"></i> ربط الجهازين
                    </button>
                </div>
            </div>

            <!-- Upload Controls (V4 Style + V5 Logic) -->
            <div id="upload-controls" class="glass-panel rounded-xl p-5 opacity-50 pointer-events-none transition-all duration-500 relative">
                <!-- Overlay for Zipping Process -->
                <div id="zip-overlay" class="absolute inset-0 bg-black/90 z-20 hidden flex flex-col items-center justify-center">
                    <i class="fas fa-cog zip-spinner text-gold text-2xl mb-2"></i>
                    <span class="text-xs text-white font-bold">جاري ضغط المجلد...</span>
                    <span class="text-[9px] text-gray-500">يرجى الانتظار</span>
                </div>

                <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">أدوات الرفع</h2>
                
                <div class="grid grid-cols-2 gap-3">
                    <!-- File Upload -->
                    <button onclick="document.getElementById('file-input').click()" class="flex flex-col items-center justify-center bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-blue-500 rounded-xl p-4 transition group">
                        <i class="fas fa-file-alt text-2xl text-blue-400 mb-2 group-hover:scale-110 transition"></i>
                        <span class="text-xs font-bold">ملفات</span>
                        <span class="text-[9px] text-gray-500">اختيار متعدد</span>
                    </button>
                    <input type="file" id="file-input" multiple class="hidden">

                    <!-- Folder Upload (V5 Logic: Auto Zip) -->
                    <button onclick="document.getElementById('folder-input').click()" class="flex flex-col items-center justify-center bg-gray-800 hover:bg-gray-700 border border-gray-700 hover:border-gold rounded-xl p-4 transition group relative overflow-hidden">
                        <div class="absolute top-0 left-0 bg-gold text-black text-[8px] font-bold px-1.5 py-0.5 rounded-br">AUTO ZIP</div>
                        <i class="fas fa-folder-open text-2xl text-gold mb-2 group-hover:scale-110 transition"></i>
                        <span class="text-xs font-bold">مجلد</span>
                        <span class="text-[9px] text-gray-500">سيتم ضغطه تلقائياً</span>
                    </button>
                    <input type="file" id="folder-input" webkitdirectory directory multiple class="hidden">
                </div>
            </div>

            <!-- Stats -->
            <div class="glass-panel rounded-xl p-4 grid grid-cols-2 gap-4 text-center">
                <div>
                    <div class="text-[10px] text-gray-500">حجم النقل</div>
                    <div class="text-lg font-code font-bold text-white" id="total-traffic">0 MB</div>
                </div>
                <div>
                    <div class="text-[10px] text-gray-500">الملفات</div>
                    <div class="text-lg font-code font-bold text-white" id="total-files">0</div>
                </div>
            </div>
        </div>

        <!-- Right Column: Manager (8 Cols) -->
        <div class="lg:col-span-8 flex flex-col h-[500px] lg:h-auto">
            
            <!-- Tabs (V4 Design) -->
            <div class="flex border-b border-gray-800 bg-black/40 rounded-t-xl overflow-hidden">
                <button onclick="switchTab('queue')" id="tab-queue" class="tab-btn active flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2">
                    <i class="fas fa-upload"></i> قيد الانتظار <span id="queue-count" class="bg-gray-800 text-[10px] px-1.5 rounded text-white ml-1">0</span>
                </button>
                <button onclick="switchTab('received')" id="tab-received" class="tab-btn flex-1 py-3 text-sm font-bold flex items-center justify-center gap-2">
                    <i class="fas fa-download"></i> تم الاستلام <span id="received-count" class="bg-red-900 text-[10px] px-1.5 rounded text-white ml-1">0</span>
                </button>
            </div>

            <!-- Display Area -->
            <div class="glass-panel border-t-0 rounded-b-xl flex-1 relative overflow-hidden flex flex-col">
                
                <!-- Active Transfer (Sticky) -->
                <div id="active-transfer-ui" class="hidden bg-red-900/10 border-b border-red-500/20 p-3">
                    <div class="flex justify-between text-xs mb-1">
                        <span id="current-file-name" class="text-white font-bold truncate max-w-[70%]">Processing...</span>
                        <span id="transfer-percent" class="text-gold font-code">0%</span>
                    </div>
                    <div class="w-full bg-gray-800 h-1 rounded-full overflow-hidden">
                        <div id="progress-bar" class="bg-red-600 h-full w-0 transition-all duration-200"></div>
                    </div>
                </div>

                <!-- Lists -->
                <div class="relative flex-1 overflow-y-auto p-4 custom-scrollbar bg-black/20">
                    <div id="view-queue" class="space-y-2">
                        <div class="text-center text-gray-600 text-sm mt-10 empty-msg"><i class="fas fa-box-open text-4xl mb-3 opacity-50"></i><p>الطابور فارغ</p></div>
                    </div>
                    <div id="view-received" class="space-y-2 hidden">
                        <div class="text-center text-gray-600 text-sm mt-10 empty-msg"><i class="fas fa-history text-4xl mb-3 opacity-50"></i><p>السجل فارغ</p></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <footer class="text-center text-[10px] text-gray-600 py-4">
        AboElfadl Systems V6 | Hybrid Edition
    </footer>

    <script>
        // --- Core Variables ---
        let peer = null;
        let conn = null;
        let myId = null;
        let fileQueue = [];
        let isTransferring = false;
        let stats = { size: 0, count: 0 };

        // --- Initialization ---
        window.onload = () => {
            initPeer();
            loadStats();
        };

        function initPeer() {
            peer = new Peer(null, { debug: 1 });

            peer.on('open', (id) => {
                myId = id;
                document.getElementById('my-id').innerText = id;
                // Auto-reconnect check logic can be added here
            });

            peer.on('connection', (c) => setupConnection(c));
            
            peer.on('error', (err) => {
                console.error(err);
                updateStatus('error');
            });
            
            peer.on('disconnected', () => {
                updateStatus('offline');
                peer.reconnect();
            });
        }

        // --- Connection Logic ---
        function connectPeer() {
            const remoteId = document.getElementById('remote-id').value.trim();
            if(!remoteId) return alert("الرجاء إدخال ID");
            updateStatus('connecting');
            const c = peer.connect(remoteId);
            setupConnection(c);
        }

        function setupConnection(c) {
            conn = c;
            conn.on('open', () => {
                updateStatus('online');
                activateControls();
                conn.send({ type: 'sys', msg: 'CONNECTED' });
            });

            conn.on('data', (data) => handleData(data));
            
            conn.on('close', () => {
                endSession(); // Trigger Kill Switch Logic on close
            });
        }

        // --- V5 Feature: Kill Switch ---
        function endSession() {
            if(conn) conn.close();
            if(peer) peer.destroy();
            updateStatus('offline');
            deactivateControls();
            alert("تم إنهاء الجلسة.");
            location.reload(); // Clean refresh
        }

        // --- File Handling (Standard) ---
        document.getElementById('file-input').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            addFilesToQueue(files);
        });

        // --- V5 Feature: Folder Auto-Zip ---
        document.getElementById('folder-input').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;

            // Show Loading Overlay
            document.getElementById('zip-overlay').classList.remove('hidden');

            try {
                const zip = new JSZip();
                
                // Add files to zip keeping structure
                let folderName = "Archive";
                if(files[0].webkitRelativePath) {
                    folderName = files[0].webkitRelativePath.split('/')[0];
                }

                files.forEach(file => {
                    const path = file.webkitRelativePath || file.name;
                    zip.file(path, file);
                });

                // Generate Zip Blob
                const content = await zip.generateAsync({type: "blob"});
                
                // Create File Object
                const zipFile = new File([content], `${folderName}.zip`, {type: "application/zip"});

                // Hide Overlay & Add to Queue
                document.getElementById('zip-overlay').classList.add('hidden');
                addFilesToQueue([zipFile]);

            } catch (err) {
                console.error(err);
                document.getElementById('zip-overlay').classList.add('hidden');
                alert("فشل في ضغط المجلد");
            }
        });

        function addFilesToQueue(files) {
            if (!files.length) return;
            files.forEach(file => {
                const fileObj = {
                    file: file,
                    id: Math.random().toString(36).substr(2, 9),
                    status: 'pending'
                };
                fileQueue.push(fileObj);
                renderQueueItem(fileObj);
            });
            updateCounts();
            if (!isTransferring) processQueue();
            switchTab('queue');
        }

        // --- Sending Logic (Async Queue) ---
        async function processQueue() {
            if (fileQueue.length === 0) {
                isTransferring = false;
                hideProgress();
                return;
            }

            isTransferring = true;
            const item = fileQueue[0];
            const file = item.file;

            markItemStatus(item.id, 'uploading');
            showProgress(file.name);

            try {
                await sendFile(file);
                markItemStatus(item.id, 'done');
                stats.count++;
                stats.size += file.size;
                saveStats();
                fileQueue.shift(); 
            } catch (err) {
                console.error(err);
                markItemStatus(item.id, 'error');
                fileQueue.shift(); 
            }
            
            updateCounts();
            setTimeout(processQueue, 200);
        }

        function sendFile(file) {
            return new Promise((resolve, reject) => {
                if (!conn || !conn.open) return reject('No connection');

                conn.send({ 
                    type: 'meta', 
                    name: file.name, 
                    size: file.size, 
                    mime: file.type,
                    category: getCategory(file.name)
                });

                const chunkSize = 16 * 1024;
                let offset = 0;
                const reader = new FileReader();

                reader.onload = (e) => {
                    conn.send({ type: 'chunk', content: e.target.result });
                    offset += chunkSize;
                    updateProgressBar(offset, file.size);
                    if (offset < file.size) {
                        setTimeout(() => readSlice(offset), 0);
                    } else {
                        resolve();
                    }
                };
                reader.onerror = reject;
                const readSlice = (o) => {
                    const slice = file.slice(o, o + chunkSize);
                    reader.readAsArrayBuffer(slice);
                };
                readSlice(0);
            });
        }

        // --- Receiving Logic ---
        let incoming = { chunks: [], meta: null, received: 0 };

        function handleData(data) {
            if (data.type === 'meta') {
                incoming.meta = data;
                incoming.chunks = [];
                incoming.received = 0;
                showProgress(data.name + " (جاري الاستلام)");
                switchTab('received');
            } 
            else if (data.type === 'chunk') {
                incoming.chunks.push(data.content);
                incoming.received += data.content.byteLength;
                updateProgressBar(incoming.received, incoming.meta.size);
                if (incoming.received >= incoming.meta.size) {
                    saveFile();
                }
            }
        }

        function saveFile() {
            const blob = new Blob(incoming.chunks, { type: incoming.meta.mime });
            const url = URL.createObjectURL(blob);
            renderHistoryItem(incoming.meta, url);
            stats.count++;
            stats.size += incoming.meta.size;
            saveStats();
            hideProgress();
        }

        // --- UI & Helpers ---
        function getCategory(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) return 'image';
            if (['mp4', 'mkv'].includes(ext)) return 'video';
            if (['zip', 'rar'].includes(ext)) return 'zip';
            if (['pdf', 'doc', 'txt'].includes(ext)) return 'doc';
            return 'file';
        }

        function getIconClass(category) {
            const map = {
                'image': 'fa-image type-image',
                'video': 'fa-video type-video',
                'zip': 'fa-file-archive type-zip',
                'doc': 'fa-file-alt type-doc',
                'file': 'fa-file text-gray-500'
            };
            return map[category] || map['file'];
        }

        function renderQueueItem(item) {
            const container = document.getElementById('view-queue');
            container.querySelector('.empty-msg')?.remove();
            const div = document.createElement('div');
            div.id = `item-${item.id}`;
            div.className = "flex items-center gap-3 bg-black/40 p-3 rounded border border-gray-700 slide-in";
            div.innerHTML = `
                <i class="fas ${getIconClass(getCategory(item.file.name))} text-xl"></i>
                <div class="flex-1 overflow-hidden">
                    <div class="text-xs font-bold text-gray-300 truncate">${item.file.name}</div>
                    <div class="text-[10px] text-gray-500">${formatBytes(item.file.size)}</div>
                </div>
                <div class="status-icon text-xs text-gray-500"><i class="fas fa-clock"></i></div>
            `;
            container.appendChild(div);
        }

        function renderHistoryItem(meta, url) {
            const container = document.getElementById('view-received');
            container.querySelector('.empty-msg')?.remove();
            const div = document.createElement('div');
            div.className = "flex items-center gap-3 bg-gray-900/80 p-3 rounded border border-gray-700 slide-in group hover:border-gold transition";
            div.innerHTML = `
                <div class="w-10 h-10 rounded bg-black flex items-center justify-center"><i class="fas ${getIconClass(meta.category || getCategory(meta.name))} text-lg"></i></div>
                <div class="flex-1 overflow-hidden">
                    <div class="text-xs font-bold text-white truncate">${meta.name}</div>
                    <div class="text-[10px] text-gray-500">${formatBytes(meta.size)}</div>
                </div>
                <a href="${url}" download="${meta.name}" class="w-8 h-8 rounded-full bg-red-900 hover:bg-red-600 flex items-center justify-center text-white transition shadow-lg"><i class="fas fa-download text-xs"></i></a>
            `;
            container.insertBefore(div, container.firstChild);
            updateCounts();
        }

        function markItemStatus(id, status) {
            const el = document.getElementById(`item-${id}`);
            if (!el) return;
            const icon = el.querySelector('.status-icon');
            if (status === 'uploading') { el.classList.add('border-blue-500'); icon.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-400"></i>'; }
            else if (status === 'done') { el.classList.replace('border-blue-500', 'border-green-900'); el.classList.add('opacity-50'); icon.innerHTML = '<i class="fas fa-check text-green-500"></i>'; }
            else if (status === 'error') { el.classList.add('border-red-500'); icon.innerHTML = '<i class="fas fa-times text-red-500"></i>'; }
        }

        function updateStatus(state) {
            const badge = document.getElementById('status-badge');
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const killBtn = document.getElementById('kill-switch');

            if (state === 'online') {
                badge.className = "flex items-center gap-2 px-3 py-1 rounded border border-green-900 bg-green-900/20 text-xs font-bold text-green-400 pulse-gold";
                dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]";
                text.innerText = "CONNECTED";
                killBtn.classList.remove('hidden');
            } else {
                badge.className = "flex items-center gap-2 px-3 py-1 rounded border border-gray-800 bg-gray-900/50 text-xs font-bold text-gray-500";
                dot.className = "w-2 h-2 rounded-full bg-gray-600";
                text.innerText = "OFFLINE";
                if(state !== 'connecting') killBtn.classList.add('hidden');
            }
        }

        function activateControls() { document.getElementById('upload-controls').classList.remove('opacity-50', 'pointer-events-none'); }
        function deactivateControls() { document.getElementById('upload-controls').classList.add('opacity-50', 'pointer-events-none'); }
        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');
            document.getElementById('view-queue').classList.add('hidden');
            document.getElementById('view-received').classList.add('hidden');
            document.getElementById(`view-${t}`).classList.remove('hidden');
        }
        function showProgress(t) { document.getElementById('active-transfer-ui').classList.remove('hidden'); document.getElementById('current-file-name').innerText = t; }
        function hideProgress() { setTimeout(() => { document.getElementById('active-transfer-ui').classList.add('hidden'); document.getElementById('progress-bar').style.width = '0'; }, 1000); }
        function updateProgressBar(l, t) { const p = ((l/t)*100).toFixed(1); document.getElementById('progress-bar').style.width = `${p}%`; document.getElementById('transfer-percent').innerText = `${p}%`; }
        function updateCounts() { document.getElementById('queue-count').innerText = fileQueue.length; document.getElementById('received-count').innerText = document.getElementById('view-received').children.length - (document.querySelector('#view-received .empty-msg') ? 1 : 0); }
        function loadStats() { const s = localStorage.getItem('aboelfadl_v6_stats'); if(s) stats = JSON.parse(s); drawStats(); }
        function saveStats() { localStorage.setItem('aboelfadl_v6_stats', JSON.stringify(stats)); drawStats(); }
        function drawStats() { document.getElementById('total-traffic').innerText = formatBytes(stats.size); document.getElementById('total-files').innerText = stats.count; }
        function copyMyId() { navigator.clipboard.writeText(myId); alert('تم النسخ'); }
        function formatBytes(b) { if(b===0)return'0 B'; const k=1024; const s=['B','KB','MB','GB']; const i=Math.floor(Math.log(b)/Math.log(k)); return parseFloat((b/Math.pow(k,i)).toFixed(1))+' '+s[i]; }
    </script>
</body>
</html>


